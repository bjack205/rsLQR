<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>rsLQR: The rsLQR Algorithm</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">rsLQR<span id="projectnumber">&#160;0.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('page_rslqr.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">The rsLQR Algorithm </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2><a class="anchor" id="autotoc_md48"></a>
Algorithm Overview</h2>
<p >The rsLQR algorithm works by recursively solving 3x3 Schur compliments of the form: </p><p class="formulaDsp">
\[ \begin{bmatrix} A &amp; D \\ D^T &amp; B &amp; E^T \\ &amp; E &amp; C \\ \end{bmatrix} \begin{bmatrix} x \\ y \\ z \end{bmatrix} \begin{bmatrix} a \\ b \\ c \end{bmatrix} \]
</p>
<p >When solving this system, we need to solve equations of the form:</p>
<p class="formulaDsp">
\[ A \bar{a} = a \]
</p>
 <p class="formulaDsp">
\[ C \bar{c} = c \]
</p>
<p >For a banded system, these solves also take the same form, so we can recursively solve these 3x3 Schur compliments, stopping the recursion when the \( A \) and \( C \) are small or dense enough to solve using e.g. a dense Cholesky decomposition. The full details of the algorithm are provided in the paper, which provides some of the details on "flattening" the algorithm to make it more amenable to parallelization on a many-core CPU. The following sections provide some details on the structure of the actual implementation.</p>
<h2><a class="anchor" id="autotoc_md49"></a>
Memory layout</h2>
<p >Most of the matrix information stored by the algorithm is stored in arrays of the following form:</p>
<p class="formulaDsp">
\[\begin{bmatrix} \Lambda_1^{(1)} &amp; \Lambda_1^{(2)} &amp; \dots &amp; \Lambda_1^{(K)} \\ X_1^{(1)} &amp; X_1^{(2)} &amp; \dots &amp; X_1^{(K)} \\ U_1^{(1)} &amp; U_1^{(2)} &amp; \dots &amp; U_1^{(K)} \\ \Lambda_2^{(1)} &amp; \Lambda_2^{(2)} &amp; \dots &amp; \Lambda_2^{(K)} \\ X_2^{(1)} &amp; X_2^{(2)} &amp; \dots &amp; X_2^{(K)} \\ U_2^{(1)} &amp; U_2^{(2)} &amp; \dots &amp; U_2^{(K)} \\ \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\ \Lambda_N^{(1)} &amp; \Lambda_N^{(2)} &amp; \dots &amp; \Lambda_N^{(K)} \\ X_N^{(1)} &amp; X_N^{(2)} &amp; \dots &amp; X_N^{(K)} \\ U_N^{(1)} &amp; U_N^{(2)} &amp; \dots &amp; U_N^{(K)} \\ \end{bmatrix} \]
</p>
<p >where \( N \) is the horizon length, \( K = \log_2{N} \) is the depth of the tree, and \( \Lambda_k^{(j)} \in \mathbb{R}^{n \times w}, X_k^{(j)} \in \mathbb{R}^{n \times w} U_k^{(j)} \in \mathbb{R}^{m \times w} \) are the blocks associated with dual variables, state variables, and control variables for knot point \( k \) and level \( j \), respectively. If a block has bar, e.g. \( \bar{X}_i^{(j)} \), it represents a piece of the factorized matrix information, whereas any block without is part of the original matrix data.</p>
<p >These blocks make up the \( D_i^{(j)}, E_i^{(j)}, a_i^{(j,p)}, \) and \( c_i^{(j,p)} \) blocks referenced in the original paper. At higher levels, each of these blocks get larger, and are therefore made up of more of these basic blocks indexed by knot point index instead of leaf index. This allows the entire algorithm to work on small blocks of similar size, decreasing the likelihood of cache misses. It also simplifies many of the parallel loops and resulting computational kernels.</p>
<h2><a class="anchor" id="autotoc_md50"></a>
High level overview</h2>
<p >Pseudocode for the algorithm, invoked by <a class="el" href="group__rsLQR.html#ga3ee14a10200c2d84096964703030dda2" title="Solve an LQR problem using rsLQR.">ndlqr_Solve()</a>, is included below: </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> K = tree.depth;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// In parallel</span></div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> index = 0; index &lt; N; ++index) {</div>
<div class="line">    <a class="code hl_function" href="group__rsLQR.html#ga87139e9514629e7e355f75f3267e72dc">ndlqr_SolveLeaf</a>(solver, index)</div>
<div class="line">}</div>
<div class="line"><span class="comment">// Sync threads</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Compute matrix factorization</span></div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> level = 0; level &lt; K; ++level) {</div>
<div class="line">    <span class="keywordtype">int</span> L = NumLeaves(level, K);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// In parallel</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; L; ++i) {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> p = level; p &lt; K; ++p) {</div>
<div class="line">            <span class="keywordtype">int</span> k = <a class="code hl_function" href="group__rsLQR.html#ga7091ad6eed6a6a2dc0e77f6c04a54529">ndlqr_GetIndexFromLeaf</a>(tree, leaf, level);</div>
<div class="line">            <a class="code hl_function" href="group__rsLQR.html#gab8b4290a3055f2e214a78189fe4ad490">ndlqr_FactorInnerProduct</a>(k, level, p);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// Sync threads</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// In parallel</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; L; ++i) {</div>
<div class="line">        FactorizeBbar(i, level);  <span class="comment">// not an actually implemented method</span></div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// Sync threads</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// In parallel</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; L; ++i) {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> p = level + 1; level &lt; K; ++p) {</div>
<div class="line">            <span class="keywordtype">int</span> k = <a class="code hl_function" href="group__rsLQR.html#ga7091ad6eed6a6a2dc0e77f6c04a54529">ndlqr_GetIndexFromLeaf</a>(tree, i, level);</div>
<div class="line">            <a class="code hl_function" href="group__rsLQR.html#ga2ab24570b3c8d44f764224ef99dfb4b6">ndlqr_SolveCholeskyFactor</a>(solver, k, level, p)</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// Sync threads</span></div>
<div class="line">    </div>
<div class="line">    <span class="comment">// In parallel</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0; k &lt; N; ++k) {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> p = level; p &lt; K; ++p) {</div>
<div class="line">            <a class="code hl_function" href="group__rsLQR.html#ga92f6b5fe4556a7ea57686566d0922ff9">ndlqr_UpdateShurFactor</a>(solver, k, level, p);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// Sync threads</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Solve for solution vector</span></div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> level = 0; level &lt; K; ++level) {</div>
<div class="line">    <span class="keywordtype">int</span> L = NumLeaves(level, K);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// In Parallel</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; L; ++i) {</div>
<div class="line">        <span class="keywordtype">int</span> k = <a class="code hl_function" href="group__rsLQR.html#ga7091ad6eed6a6a2dc0e77f6c04a54529">ndlqr_GetIndexFromLeaf</a>(i, level);</div>
<div class="line">        <a class="code hl_function" href="group__rsLQR.html#gab8b4290a3055f2e214a78189fe4ad490">ndlqr_FactorInnerProduct</a>(k, level, K+1);</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// Sync threads</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// In Parallel</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; L; ++i) {</div>
<div class="line">        <span class="keywordtype">int</span> k = <a class="code hl_function" href="group__rsLQR.html#ga7091ad6eed6a6a2dc0e77f6c04a54529">ndlqr_GetIndexFromLeaf</a>(i, level);</div>
<div class="line">        <a class="code hl_function" href="group__rsLQR.html#ga2ab24570b3c8d44f764224ef99dfb4b6">ndlqr_SolveCholeskyFactor</a>(k, level, K+1);</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// Sync threads</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// In parallel</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0; k &lt; N; ++k) {</div>
<div class="line">        <a class="code hl_function" href="group__rsLQR.html#ga92f6b5fe4556a7ea57686566d0922ff9">ndlqr_UpdateShurFactor</a>(k, level, K+1);</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// Sync threads</span></div>
<div class="line">}</div>
<div class="ttc" id="agroup__rsLQR_html_ga2ab24570b3c8d44f764224ef99dfb4b6"><div class="ttname"><a href="group__rsLQR.html#ga2ab24570b3c8d44f764224ef99dfb4b6">ndlqr_SolveCholeskyFactor</a></div><div class="ttdeci">int ndlqr_SolveCholeskyFactor(NdData *fact, CholeskyInfo *cholinfo, int index, int level, int upper_level)</div><div class="ttdoc">Use the precomputed Cholesky factorization to solve for y at each parent level.</div><div class="ttdef"><b>Definition:</b> nested_dissection.c:136</div></div>
<div class="ttc" id="agroup__rsLQR_html_ga7091ad6eed6a6a2dc0e77f6c04a54529"><div class="ttname"><a href="group__rsLQR.html#ga7091ad6eed6a6a2dc0e77f6c04a54529">ndlqr_GetIndexFromLeaf</a></div><div class="ttdeci">int ndlqr_GetIndexFromLeaf(const OrderedBinaryTree *tree, int leaf, int level)</div><div class="ttdoc">Get the knot point index given the leaf index at a given level.</div><div class="ttdef"><b>Definition:</b> binary_tree.c:65</div></div>
<div class="ttc" id="agroup__rsLQR_html_ga87139e9514629e7e355f75f3267e72dc"><div class="ttname"><a href="group__rsLQR.html#ga87139e9514629e7e355f75f3267e72dc">ndlqr_SolveLeaf</a></div><div class="ttdeci">int ndlqr_SolveLeaf(NdLqrSolver *solver, int index)</div><div class="ttdoc">Solve all the equations for the lowest-level diagonal blocks, by timestep.</div><div class="ttdef"><b>Definition:</b> nested_dissection.c:10</div></div>
<div class="ttc" id="agroup__rsLQR_html_ga92f6b5fe4556a7ea57686566d0922ff9"><div class="ttname"><a href="group__rsLQR.html#ga92f6b5fe4556a7ea57686566d0922ff9">ndlqr_UpdateShurFactor</a></div><div class="ttdeci">int ndlqr_UpdateShurFactor(NdData *fact, NdData *soln, int index, int i, int level, int upper_level, bool calc_lambda)</div><div class="ttdoc">Calculates  and  to complete the factorization at the current level.</div><div class="ttdef"><b>Definition:</b> nested_dissection.c:154</div></div>
<div class="ttc" id="agroup__rsLQR_html_gab8b4290a3055f2e214a78189fe4ad490"><div class="ttname"><a href="group__rsLQR.html#gab8b4290a3055f2e214a78189fe4ad490">ndlqr_FactorInnerProduct</a></div><div class="ttdeci">int ndlqr_FactorInnerProduct(NdData *data, NdData *fact, int index, int data_level, int fact_level)</div><div class="ttdoc">Calculates one of the inner products needed at level data_level.</div><div class="ttdef"><b>Definition:</b> nested_dissection.c:114</div></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">rsLQR: A Parallel Solver for LQR Problems</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4 </li>
  </ul>
</div>
</body>
</html>
